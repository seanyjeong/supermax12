<!DOCTYPE html>
<html lang="ko">
<head>
    <title>사전 현황판 (교육원별)</title>
    <style>
        body { 
            font-family: -apple-system, sans-serif; 
            padding: 10px; 
            background-color: #f4f4f8; 
            margin: 0;
        }
        .container { 
            max-width: 1600px; 
            margin: auto; 
        }
        h1 { 
            text-align: center; 
            margin: 10px 0;
            font-size: 1.5rem;
        }
        .toolbar { 
            margin-bottom: 10px; 
            text-align: center; 
        }
        .toolbar a { 
            padding: 8px 15px; 
            background-color: #007bff; 
            color: white; 
            text-decoration: none; 
            border-radius: 5px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 10px;
        }
        .session-container { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
        }
        .session-column { 
            background-color: #fff; 
            padding: 12px; 
            border-radius: 12px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.05); 
        }
        .session-column h2 { 
            margin: 0 0 10px 0; 
            padding-bottom: 8px; 
            text-align: center; 
            font-size: 1.2rem;
            border-bottom: 1px solid #eee;
        }
        .branch-card-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 10px; 
        }
        .branch-card { 
            background-color: #f8f9fa; 
            border-radius: 8px; 
            padding: 10px; 
            border: 1px solid #dee2e6; 
            cursor: pointer; 
            transition: all 0.2s;
            font-size: 0.85rem;
        }
        .branch-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .branch-card h3 { 
            margin: 0 0 8px 0; 
            font-size: 1rem; 
            text-align: center; 
        }
        .stats-list { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
            font-size: 0.8rem; 
        }
        .stats-list li { 
            display: flex; 
            justify-content: space-between; 
            padding: 4px 0; 
        }
        .stats-list li:not(:last-child) { 
            border-bottom: 1px solid #e9ecef; 
        }
        .stats-list span:last-child { 
            font-weight: 600; 
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
        }
        .modal-content { 
            background-color: #fff; 
            margin: 10% auto; 
            padding: 20px; 
            border-radius: 12px; 
            width: 90%; 
            max-width: 400px; 
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #dee2e6; 
            padding-bottom: 10px; 
            margin-bottom: 10px; 
        }
        .modal-header h2 { 
            margin: 0; 
            font-size: 1.2rem; 
        }
        .close-btn { 
            font-size: 1.5rem; 
            font-weight: bold; 
            color: #aaa; 
            cursor: pointer; 
        }
        .pending-list { 
            list-style-type: decimal; 
            padding-left: 20px; 
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .pending-list li { 
            padding: 4px 0; 
        }
        .branch-card.completed {
            background-color: #ade7fd;
            border-color: #192987;
        }

        @media (max-width: 1200px) { 
            .session-container { grid-template-columns: 1fr; } 
            .branch-card-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>사전 현황판</h1>
        <div class="toolbar"><a href="./tshirt.html" target="_blank">티셔츠 관리 페이지로 이동 &rarr;</a></div>
        <div class="session-container">
            <div class="session-column">
                <h2 id="morning-title">오전조</h2>
                <div id="morning-cards" class="branch-card-grid"></div>
            </div>
            <div class="session-column">
                <h2 id="afternoon-title">오후조</h2>
                <div id="afternoon-cards" class="branch-card-grid"></div>
            </div>
        </div>
    </div>

    <div id="pending-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <ul id="modal-list" class="pending-list"></ul>
        </div>
    </div>

    <script>
        const API_URL = 'https://supermax.kr';
        const 오전조 = ['대전','강남','강동','광주','군포','논산','동탄','분당','서초','세종','수원','순천여수광양','아산','영통','용인','이천','익산','전주','군산','천안','청주','충주','하남','경산'];
        const modal = document.getElementById('pending-modal');

        async function loadBranchStatus() {
            try {
                const response = await fetch(`${API_URL}/26susi/dashboard/pre-event`);
                const result = await response.json();
                if (result.success) {
                    const morningContainer = document.getElementById('morning-cards');
                    const afternoonContainer = document.getElementById('afternoon-cards');
                    let morningHtml = '', afternoonHtml = '';
                    let morningCount = 0, afternoonCount = 0;

                    result.data.forEach(item => {
                        const cardClass = (item.pending === 0) ? 'branch-card completed' : 'branch-card';
                        const cardHtml = `
                            <div class="${cardClass}" onclick="showPendingStudents('${item.branch_name}')">
                                <h3>${item.branch_name}</h3>
                                <ul class="stats-list">
                                    <li><span>미</span> <span>${item.pending}</span></li>
                                    <li><span>참</span> <span>${item.present}</span></li>
                                    <li><span>결</span> <span>${item.absent}</span></li>
                                    <li><span>대</span> <span>${item.substitute}</span></li>
                                    <li><span>신</span> <span>${item.new_count}</span></li>
                                </ul>
                            </div>
                        `;
                        if (오전조.includes(item.branch_name)) {
                            morningHtml += cardHtml;
                            morningCount++;
                        } else {
                            afternoonHtml += cardHtml;
                            afternoonCount++;
                        }
                    });

                    // 동적으로 지점 수 업데이트
                    document.getElementById('morning-title').textContent = `오전조 (${morningCount}개 지점)`;
                    document.getElementById('afternoon-title').textContent = `오후조 (${afternoonCount}개 지점)`;
                    document.querySelector('h1').textContent = `사전 현황판 (총 ${morningCount + afternoonCount}개 지점)`;

                    morningContainer.innerHTML = morningHtml || '<p>데이터가 없습니다.</p>';
                    afternoonContainer.innerHTML = afternoonHtml || '<p>데이터가 없습니다.</p>';
                }
            } catch (error) { 
                console.error("사전 현황판 로딩 오류:", error); 
            }
        }
        
        async function showPendingStudents(branchName) {
            const modalTitle = document.getElementById('modal-title');
            const modalList = document.getElementById('modal-list');
            
            modalTitle.textContent = `${branchName} 미확인 인원`;
            modalList.innerHTML = '<li>로딩 중...</li>';
            modal.style.display = 'block';

            try {
                const response = await fetch(`${API_URL}/26susi/students/pending?branchName=${encodeURIComponent(branchName)}`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    modalList.innerHTML = result.data.map(s => `<li>${s.student_name} (${s.exam_number || '수험번호 미배정'})</li>`).join('');
                } else {
                    modalList.innerHTML = '<li>미확인 인원이 없습니다.</li>';
                }
            } catch (error) {
                modalList.innerHTML = '<li>명단을 불러오는 데 실패했습니다.</li>';
            }
        }

        function closeModal() {
            modal.style.display = 'none';
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        window.onload = loadBranchStatus;
    </script>
</body>
</html>
