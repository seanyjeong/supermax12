<!DOCTYPE html>
<html lang="ko">
<head>
    <title>ë§ˆìŠ¤í„° í•™ìƒ ì¼ê´„ ë“±ë¡</title>
    <script src="https://cdn.jsdelivr.net/npm/handsontable@12/dist/handsontable.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/handsontable@12/dist/handsontable.full.min.css" rel="stylesheet">
    
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        h1 { text-align: center; }
        .form-section { border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
        button { font-size: 1.2em; padding: 15px 30px; cursor: pointer; color: white; border: none; border-radius: 8px; margin-top: 15px; background-color: #28a745; }
        .instructions { font-size: 0.9em; color: #666; margin-bottom: 10px; }
        #spreadsheet { width: 100%; height: 500px; overflow: hidden; } 
    </style>
</head>
<body>
    <div class="container">
        <h1>ë§ˆìŠ¤í„° í•™ìƒ ì¼ê´„ ë“±ë¡</h1>
        
        <div class="form-section">
            <div class="instructions">
                ğŸ’¡ ì—‘ì…€ì—ì„œ **êµìœ¡ì›, ì´ë¦„, ì„±ë³„, í•™êµ, í•™ë…„** ìˆœì„œë¡œ ë³µì‚¬í•´ì„œ ì²« ë²ˆì§¸ ì…€ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
            </div>
            <div id="spreadsheet"></div>
            <button onclick="addStudentsInBulk()">ì „ì²´ ëª…ë‹¨ ì¼ê´„ ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://supermax.kr';
        const container = document.getElementById('spreadsheet');
        // â­ï¸ í–‰ ê°œìˆ˜ë¥¼ ë„‰ë„‰í•˜ê²Œ 3000ê°œë¡œ ì„¤ì •
        const hot = new Handsontable(container, {
            data: Handsontable.helper.createEmptySpreadsheetData(3000, 5),
            colHeaders: ['êµìœ¡ì›', 'ì´ë¦„', 'ì„±ë³„', 'í•™êµ', 'í•™ë…„'],
            columns: [
                {}, // êµìœ¡ì›
                {}, // ì´ë¦„
                { type: 'dropdown', source: ['ë‚¨', 'ì—¬'] }, // ì„±ë³„
                {}, // í•™êµ
                {}  // í•™ë…„
            ],
            rowHeaders: true,
            colWidths: [150, 100, 80, 150, 100],
            height: 500, // ê³ ì • ë†’ì´ë¥¼ ì£¼ì–´ ì„±ëŠ¥ í™•ë³´
            licenseKey: 'non-commercial-and-evaluation'
        });

// master-register.htmlì˜ ìŠ¤í¬ë¦½íŠ¸
// master-register.htmlì˜ ìŠ¤í¬ë¦½íŠ¸
// master-register.htmlì˜ ìŠ¤í¬ë¦½íŠ¸
async function addStudentsInBulk() {
    const allGridData = hot.getData();
    const pastedData = allGridData.filter((row, index) => !hot.isEmptyRow(index));

    if (pastedData.length === 0) {
        return alert('ë“±ë¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }

    // â­ï¸ ì´ ë¶€ë¶„ì„ ì¶”ê°€í•´ì„œ ì—ëŸ¬ë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
    let invalidRowsByBranch = {};
    let invalidRowCount = 0;

    const cleanedData = pastedData.map(row => {
        return row.map(cell => (typeof cell === 'string' ? cell.trim() : cell));
    });

    const validStudents = cleanedData.map((row, index) => {
        const student = { branch: row[0], name: row[1], gender: row[2], school: row[3], grade: row[4] };
        
        const missingFields = [];
        if (!student.branch) missingFields.push('êµìœ¡ì›');
        if (!student.name) missingFields.push('ì´ë¦„');
        if (!['ë‚¨', 'ì—¬'].includes(student.gender)) missingFields.push('ì„±ë³„');
        if (!student.grade) missingFields.push('í•™ë…„');

        if (missingFields.length === 0) {
            return student;
        } else {
            const branchName = student.branch || '[êµìœ¡ì› ì´ë¦„ ì—†ìŒ]';
            if (!invalidRowsByBranch[branchName]) {
                invalidRowsByBranch[branchName] = [];
            }
            invalidRowsByBranch[branchName].push(`- ${index + 1}ë²ˆì§¸ ì¤„ (ëˆ„ë½: ${missingFields.join(', ')})`);
            invalidRowCount++;
            return null;
        }
    }).filter(s => s !== null);

    if (invalidRowCount > 0) {
        let message = `ë¶™ì—¬ë„£ì€ ${pastedData.length}ëª… ì¤‘ ${invalidRowCount}ëª…ì˜ ë°ì´í„°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.\n\n[ëˆ„ë½ ì˜ì‹¬ ë°ì´í„° ìƒì„¸]\n`;
        for (const branch in invalidRowsByBranch) {
            message += `â–¶ ${branch}\n${invalidRowsByBranch[branch].join('\n')}\n\n`;
        }
        message += `ë¬¸ì œê°€ ìˆëŠ” ë°ì´í„°ë¥¼ ì œì™¸í•˜ê³  ${validStudents.length}ëª…ë§Œ ë“±ë¡ì„ ê³„ì†í• ê¹Œìš”?`;

        if (!confirm(message)) {
            return;
        }
    } else {
        if (!confirm(`ì´ ${validStudents.length}ëª…ì˜ í•™ìƒì„ ë“±ë¡í• ê¹Œìš”?`)) return;
    }
    
    // ì´í•˜ ë¶„í•  ì „ì†¡ ë¡œì§ì€ ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤.
    const chunkSize = 500;
    const totalChunks = Math.ceil(validStudents.length / chunkSize);
    let successCount = 0;

    for (let i = 0; i < totalChunks; i++) {
        const chunk = validStudents.slice(i * chunkSize, (i + 1) * chunkSize);
        alert(`ë°ì´í„° ë¶„í•  ì „ì†¡ (${i + 1}/${totalChunks}) - ${chunk.length}ëª… ì „ì†¡ ì‹œì‘`);
        try {
            const response = await fetch(`${API_URL}/26susi/students/master-bulk`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ students: chunk })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || `ì„œë²„ ì—ëŸ¬: ${response.status}`);
            if (result.insertedCount) {
                successCount += result.insertedCount;
            }
        } catch (error) {
            alert(`ì „ì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}\nì§€ê¸ˆê¹Œì§€ ${successCount}ëª…ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            return;
        }
    }
    alert(`ì´ ${successCount}ëª…ì˜ í•™ìƒ ë“±ë¡ì„ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!`);
    hot.loadData(Handsontable.helper.createEmptySpreadsheetData(3000, 5));
}
    </script>
</body>
</html>